version: '3.9'

services:
  djangoapp:
    container_name: djangoapp
    build: 
      context: .
      # A opção `dockerfile` deve apontar para o nome do Dockerfile (arquivo),
      # não para um diretório. O valor padrão é "Dockerfile", então podemos
      # simplesmente removê-lo ou defini-lo explicitamente.
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    volumes:
      - ./djangoapp:/djangoapp
      # Usar volumes nomeados para static/media evita problemas de permissões
      # quando os diretórios não existem no host ou são criados como root.
      - static_volume:/data/web/static
      - media_volume:/data/web/media
    env_file:
      - ./dotenv_files/.env
    depends_on:
      psql:
        condition: service_healthy
  
  psql:
    container_name: psql
    image: postgres:14-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Script de init para criar database "blog_user" automaticamente
      - ./scripts/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    env_file:
      - ./dotenv_files/.env
    healthcheck:
      # Verifica usando o DB existente para evitar tentativas em um DB igual ao usuário
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

volumes:
  static_volume:
  media_volume:
  postgres_data: